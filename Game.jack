class Game {
    field Lifecycle lifecycle;
    static int MENU_NONE, MENU_MAIN, MENU_EXAMPLES, MENU_STILL_LIFES, MENU_OSCILLATORS, MENU_SPACESHIPS;
    static char KEY_E, KEY_L, KEY_O, KEY_P, KEY_Q, KEY_S, KEY_M, KEY_H, KEY_NONE;

    constructor Game new() {
        return this;
    }
    
    function void init() {
        let MENU_MAIN = 1;
        let MENU_EXAMPLES = 2;
        let MENU_STILL_LIFES = 3;
        let MENU_OSCILLATORS = 4;
        let MENU_SPACESHIPS = 5;
        let KEY_E = 69;
        let KEY_H = 72;
        let KEY_L = 76;
        let KEY_M = 77;
        let KEY_O = 79;
        let KEY_P = 80;
        let KEY_Q = 81;
        let KEY_S = 83;
        return;
    }

    method void run() {
        var char key;
        var boolean quit, running;
        var int menu;

        let lifecycle = Lifecycle.new();
        let quit = false;
        let running = false;
        let menu = MENU_MAIN;
        do Menu.showMainMenu();

        while (~quit) {
            let key = Keyboard.keyPressed();

            // examples menu
            if ((key = KEY_E) & (menu = MENU_MAIN)) { 
                let menu = MENU_EXAMPLES; 
                do Menu.showExamplesMenu();
            }

            // still lifes
            if ((key = KEY_L) & (menu = MENU_EXAMPLES)) {
                let menu = MENU_STILL_LIFES;
                do Menu.showStillLifesMenu();
                do Examples.buildStillLifes(lifecycle, 9);
                let running = true;
            } 

            // oscillators
            if ((key = KEY_O) & (menu = MENU_EXAMPLES)) {
                let menu = MENU_OSCILLATORS;
                do Menu.showOscillatorsMenu();
                do Examples.buildOscillators(lifecycle);
                let running = true;
            }

            // spaceships
            if ((key = KEY_S) & (menu = MENU_EXAMPLES)) {
                let menu = MENU_SPACESHIPS;
                do Menu.showSpaceshipsMenu();
            }

            if (menu = MENU_SPACESHIPS) {
                if (key = KEY_L) {
                    do Examples.addLightWeightSpaceship(lifecycle);
                    let running = true;
                }
                if (key = KEY_M) {
                    do Examples.addMiddleWeightSpaceship(lifecycle);
                    let running = true;
                }
                if (key = KEY_H) {
                    do Examples.addHeavyWeightSpaceship(lifecycle);
                    let running = true;
                }
            }

            // pause or unpause
            if ((key = KEY_P) & ((menu = MENU_STILL_LIFES) | (menu = MENU_SPACESHIPS) | (menu = MENU_OSCILLATORS))) {
                let running = ~running;
            }

            // quit or move back to previous menu
            if (key = KEY_Q) {
                if (menu = MENU_MAIN) { 
                    do Menu.showFarewellMessage();
                    let quit = true; 
                } 
                if (menu = MENU_EXAMPLES) { 
                    let menu = MENU_MAIN; 
                    do Menu.showMainMenu();
                }
                if ((menu = MENU_STILL_LIFES) | (menu = MENU_OSCILLATORS) | (menu = MENU_SPACESHIPS)) { 
                    let menu = MENU_EXAMPLES; 
                    do lifecycle.clear();
                    do Menu.showExamplesMenu();
                }
                let running = false;
            }
            if (~(key = KEY_NONE)) {
                do KeyboardHelper.waitForKeyReleased(key);
            }

            if (running) {
                do Grid.fillFromArray(lifecycle.getCurrentIteration());
                do lifecycle.tick();
                do KeyboardHelper.waitForTimePeriodOrKeyPress(650);
            }
        }

        return;
    }

    method void dispose() {
        do lifecycle.dispose();
        do Memory.deAlloc(this);
        return;
    }

}